<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="David Betteridge">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Single Sign On (SSO) - Technical Documentation</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/extra.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">Technical Documentation</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">PROACTIS</a>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">P2P <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../Placeholder/">Overview</a>
</li>
                            
<li class="active">
    <a href="./">Single Sign On (SSO)</a>
</li>
                            
<li >
    <a href="../punchout/">Punchout</a>
</li>
                            
<li >
    <a href="../../placeholder/">Invoice Posting</a>
</li>
                            
<li >
    <a href="../../placeholder/">Budget Checking</a>
</li>
                            
<li >
    <a href="../../placeholder/">Nominal Validation</a>
</li>
                            
<li >
    <a href="../../placeholder/">Imaging Integration</a>
</li>
                            
  <li class="dropdown-submenu">
    <a href="#">Import APIs</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../../placeholder/">Invoices</a>
</li>
    </ul>
  </li>
                        </ul>
                    </li>
                    <li >
                        <a href="../../placeholder/">Spend Analytics</a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">APF <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../../apf/overview/">overview</a>
</li>
                            
<li >
    <a href="../../apf/overview/">p2p to apf</a>
</li>
                            
<li >
    <a href="../../apf/financesystem_to_paymentserver/">Finance System to Payments Server</a>
</li>
                        </ul>
                    </li>
                    <li >
                        <a href="../../s2c/placeholder/">S2C</a>
                    </li>
                    <li >
                        <a href="../../dueNorth/Placeholder/">DueNorth</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../Placeholder/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../punchout/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/proactis-documentation/ExampleApplications">CodeExamples
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#p2p-single-sign-on-sso">P2P Single-Sign-On (SSO)</a></li>
            <li><a href="#windows-authentication">Windows Authentication</a></li>
            <li><a href="#saml2">SAML2</a></li>
            <li><a href="#external">External</a></li>
            <li><a href="#bespoke">Bespoke</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="p2p-single-sign-on-sso">P2P Single-Sign-On (SSO)</h1>
<p>By default PROACTIS expects the users to enter their username and password in order to login into PROACTIS P2P.   This document lists the possible ways in which PROACTIS P2P can be configured to allow users to authenticate using Single-Sign-On.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you wish your users to use a combination of PROACTIS and SSO logins then add the following setting to the <strong>ApplicationConfiguration.xml</strong> file.</p>
</div>
<pre><code class="xml">&lt;Setting Name=&quot;AllowPROACTISLogins&quot;&gt;True&lt;/Setting&gt;
</code></pre>

<hr />
<h2 id="windows-authentication">Windows Authentication</h2>
<p>If your PROACTIS P2P server is on the same domain as your users then the system can be configured so that they are automatically signed on without the need for them to re-enter their username and password.</p>
<ul>
<li>Ensure that Windows Authentication is enabled in IIS for your PROACTIS website</li>
</ul>
<p>It must first be installed as part of the <strong>Web Server</strong> role. </p>
<p><img alt="alt text" src="../../img/p2p/sso/iis_feature.JPG" title="ServerRole" /></p>
<p>And then enabled in the authentication section of your website</p>
<p><img alt="alt text" src="../../img/p2p/sso/iis_config.JPG" title="Config" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If some of your users aren't on your domain,  then leave anonymous authentication enabled for them.</p>
</div>
<ul>
<li>Add the following setting to the <strong>ApplicationConfiguration.xml</strong> file.</li>
</ul>
<pre><code class="xml">&lt;Setting Name=&quot;AuthenticationMethod&quot;&gt;WINDOWS&lt;/Setting&gt;
</code></pre>

<ul>
<li>Set the <strong>NTLogon</strong> flag to True against the users,  and ensure that their usernames are in the format DOMAIN\Username.  <em>For example PROACTIS\DavidBetteridge</em></li>
</ul>
<hr />
<h2 id="saml2">SAML2</h2>
<p>PROACTIS P2P has built in support for SSO using the industry standard <a href="https://en.wikipedia.org/wiki/SAML_2.0">SAML2</a> protocol.</p>
<ul>
<li>First generate (or obtain) a local certificate and provide the public part of this to your identity provider.</li>
</ul>
<pre><code class="batch">makecert -r -pe -n &quot;CN=your_cert_name&quot; -sky exchange -sv mycert.pvk mycert.cer

Enter yourPassword for the subject key (3 times!)

pvk2pfx.exe -pvk mycert.pvk -spc mycert.cer  -pi yourPassword -pfx mycert.pfx -po yourPassword
</code></pre>

<ul>
<li>With in your website's customer folder create a file called <strong>saml.config</strong>.   This should be based on the following template.</li>
</ul>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;SAMLConfiguration xmlns=&quot;urn:componentspace:SAML:2.0:configuration&quot;&gt;
   &lt;ServiceProvider Name=&quot;service-provider-name&quot;
                    AssertionConsumerServiceUrl=&quot;~/SystemLogon/AssertionConsumerService&quot;
                    LocalCertificateFile=&quot;path-to-local-certificate-file&quot;
                    LocalCertificatePassword=&quot;local-certificate-password&quot;/&gt;
 
 
   &lt;!-- ADFS --&gt;
   &lt;PartnerIdentityProviders&gt;
      &lt;PartnerIdentityProvider Name=&quot;partner-identity-provider-name&quot;
                Description=&quot;PROACTIS AD&quot;
                               SignAuthnRequest=&quot;false&quot;
                               WantSAMLResponseSigned=&quot;false&quot;
                               WantAssertionSigned=&quot;true&quot;
                               WantAssertionEncrypted=&quot;true&quot;
                               PartnerCertificateFile=&quot;path-to-partner-certificate-file&quot;
                               ClockSkew=&quot;00:03:00&quot;
                               SingleSignOnServiceUrl=&quot;single-sign-on-service-url&quot;/&gt;
   &lt;/PartnerIdentityProviders&gt;
 
&lt;/SAMLConfiguration&gt;
</code></pre>

<ul>
<li>Add the following settings to your application.configuration file</li>
</ul>
<pre><code class="xml">&lt;Setting Name=&quot;SSOAttributeName&quot;&gt;NameID&lt;/Setting&gt;
</code></pre>

<p>The name of the attribute containing the user identifier in the attributes list returned from the ADFS server.
If not specified then no attribute lookup is made and user identification is based on the “username” returned from the ADFS server.
 </p>
<pre><code class="xml">&lt;Setting Name=&quot;SSOAttributeNameMask&quot;&gt;&lt;/Setting&gt;
</code></pre>

<p>An optional mask to be applied to the above user identifier value.
 </p>
<pre><code class="xml">&lt;Setting Name=&quot;SSOMatchP2PUserOnEmailAddress&quot;&gt;False&lt;/Setting&gt;
</code></pre>

<p>By default, P2P searches the database Users table to find a user whose “LoginID” matches the identifier value returned from the ADFS server.
This optional setting will cause the lookup to be made on “EmailAddress” rather than “LoginID”
 </p>
<pre><code class="xml">&lt;Setting Name=&quot;SSODatabaseTitle&quot;&gt;&lt;/Setting&gt;
</code></pre>

<p>An optional setting that only applies when a user who is already logged into a 3rd party system, initiates a logon to P2P via SSO. In this scenario, the user is not 
presented with a logon page. If the user has access to multiple databases, then this setting specifies the database title (in the database xml file) to log into.
If this setting is not present, P2P will select the default database in the databases xml file (or the first database if no default).
Obviously if only one database is available, then this setting is unnecessary.</p>
<hr />
<h2 id="external">External</h2>
<p>By default PROACTIS P2P validates the username and password entered by the user against the record in the <strong>dsdba.Users</strong> table.   It is however possible to customise PROACTIS so that users are validated against an external userstore such as LDAP.</p>
<p>The following steps should be followed in order to create an external validation DLL.</p>
<ul>
<li>
<p>Create a new C# class library with a class called <strong>Services</strong> which implements the <strong>ILogin</strong> interface.  This interface can be found in <strong>PROACTIS.P2P.grsCustInterfaces.DLL</strong></p>
</li>
<li>
<p>Decide if your login process will be called asynchronously or not and implement the UseAsynchronousImplementation as required.</p>
</li>
</ul>
<pre><code class="C#">    public bool UseAsynchronousImplementation =&gt; false;
</code></pre>

<ul>
<li>
<p>Implement the <strong>Login</strong> (or <strong>LoginAsync</strong>) method with your custom validation code.  This method should return True for a successful login and False for a failure.  (For security reasons it is not possible to return messages informing the user why the login failed.  For example <em>the username does not exist</em>)</p>
</li>
<li>
<p>Compile your code,  and ensure that the resulting DLL is named xyzLogin.DLL.   (xyz can be anything)</p>
</li>
<li>
<p>Copy the DLL into your <strong>PROACTIS P2P/Plugins</strong>  (or <strong>Plugins/[database-title]</strong>) folder.</p>
</li>
<li>
<p>Add the following setting into your <strong>applicationconfiguration.xml</strong> file.</p>
</li>
</ul>
<pre><code class="xml">&lt;Setting Name=&quot;AuthenticationMethod&quot;&gt;EXTERNAL&lt;/Setting&gt;
</code></pre>

<p>See the <a href="https://github.com/proactis-documentation/ExampleApplications/tree/master/P2P/SSO/PROACTIS.ExampleApplications.ExternalLogin">PROACTIS.ExampleApplications.ExternalLogin</a> example application for a complete sample implementation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul>
<li>In order to login using the external DLL,  the user must have their NTLogon property set to True</li>
<li>Failed login attempts aren't recorded</li>
</ul>
</div>
<hr />
<h2 id="bespoke">Bespoke</h2>
<p>It is also possible to provide your users with a completely custom login process,  including replacing the login screen and adding the ability to automatically create users the first time they connect.</p>
<p>The process is to :</p>
<ul>
<li>
<p>Create a custom page in your website's customer folder called <strong>CustomLogin</strong></p>
</li>
<li>
<p>Within that page collect any required details from the user and validate their credentials.</p>
</li>
<li>
<p>If the user entered valid details then log them on by:</p>
<ul>
<li>First generating a unique token for them</li>
<li>Then writing the token to the <strong>DSDBA.CustomLoginTokens</strong> table.</li>
<li>Finally redirecting the user's browser to CustomLoginAsync within the main site.</li>
</ul>
</li>
<li>
<p>To enable your new page to be used,  the following settings should be added to the <strong>ApplicationConfiguration</strong> file.</p>
</li>
</ul>
<pre><code class="xml">&lt;Setting Name=&quot;AuthenticationMethod&quot;&gt;CUSTOM&lt;/Setting&gt;
&lt;Setting Name=&quot;CustomLoginURL&quot;&gt;https://sp-db01/custom/CustomLogin.aspx&lt;/Setting&gt;
</code></pre>

<p>See these <a href="https://github.com/proactis-documentation/ExampleApplications/tree/master/P2P/SSO/Bespoke">example pages</a> for a complete sample.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
</div>
<p>Upon exit form P2P, the browser will be redirected back to the custom login page with the following in the querystring “action=logout”. If the custom logon page uses automated logins then it must take notice of this parameter to not automatically log the user back in again</p>
<h3 id="return-messages">Return Messages</h3>
<p>Messages are return to the custom login page using the following query string format
<code>InfoMessages=XXX&amp;AlertMessages=YYY&amp;ErrorMessages=ZZZ</code></p>
<p>Where XXX, YYY and ZZZ are base64 encoded UNICODE strings. Each encoded string contains the messages concatenate with a “|” separator. (see sample app)
These entries will only be in the querystring if there are messages to return.</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>(C) PROACTIS Group Ltd - All Rights Reserved</p>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
