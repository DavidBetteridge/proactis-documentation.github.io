<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="David Betteridge">
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Invoice Posting - Technical Documentation</title>
        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">
        <link href="../../css/extra.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
	
	<script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="../..">Technical Documentation</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                    <li >
                        <a href="../..">PROACTIS</a>
                    </li>
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">P2P <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                            
<li >
    <a href="../sso/">Single Sign On (SSO)</a>
</li>
                            
<li >
    <a href="../punchout/">PunchOut / Marketplaces</a>
</li>
                            
<li >
    <a href="../nominalvalidation/">Nominal Validation</a>
</li>
                            
<li >
    <a href="../budgetchecking/">Budget Checking</a>
</li>
                            
<li >
    <a href="../customtab/">Custom Tabs</a>
</li>
                            
<li >
    <a href="../addins/">Addins</a>
</li>
                            
  <li class="dropdown-submenu">
    <a href="#">Imaging Integration</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../genericimaging/">Generic Imaging</a>
</li>
            
<li >
    <a href="../customimaging/">Custom Imaging</a>
</li>
    </ul>
  </li>
                            
<li >
    <a href="../commitments/">Commitment Posting</a>
</li>
                            
<li class="active">
    <a href="./">Invoice Posting</a>
</li>
                            
  <li class="dropdown-submenu">
    <a href="#">Import APIs</a>
    <ul class="dropdown-menu">
            
<li >
    <a href="../acceptanceGateway/">Acceptances</a>
</li>
            
<li >
    <a href="../cancelPurhaseOrderGateway/">Cancel Purchase Order</a>
</li>
            
<li >
    <a href="../expensesGateway/">Expenses</a>
</li>
            
<li >
    <a href="../internalInvoiceGateway/">Internal Invoices</a>
</li>
            
<li >
    <a href="../purchaseCreditNoteGateway/">Purchase Credit Notes</a>
</li>
            
<li >
    <a href="../purchaseInvoiceGateway/">Purchase Invoices</a>
</li>
    </ul>
  </li>
                            
<li >
    <a href="../troubleshooting/">Troubleshooting</a>
</li>
                        </ul>
                    </li>
                    <li >
                        <a href="../../placeholder/">Spend Analytics</a>
                    </li>
                    <li >
                        <a href="../../placeholder/">APF</a>
                    </li>
                    <li >
                        <a href="../../placeholder/">S2C</a>
                    </li>
                    <li >
                        <a href="../../placeholder/">DueNorth</a>
                    </li>
                    <li >
                        <a href="../../placeholder/">System4</a>
                    </li>
                </ul>

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                    <li >
                        <a rel="next" href="../commitments/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../acceptanceGateway/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://github.com/proactis-documentation/ExampleApplications">CodeExamples
                        </a>
                    </li>
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#invoice-export">Invoice Export</a></li>
            <li><a href="#implementation">Implementation</a></li>
            <li><a href="#initialise-method">Initialise Method</a></li>
            <li><a href="#processdocument-method">ProcessDocument Method</a></li>
            <li><a href="#postingcomplete-method">PostingComplete Method</a></li>
            <li><a href="#transaction-handling">Transaction Handling</a></li>
            <li><a href="#example">Example</a></li>
            <li><a href="#deployment">Deployment</a></li>
            <li><a href="#database">Database</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="invoice-export">Invoice Export</h1>
<p>To allow the real time posting of documents into external systems; typically finance systems; a custom export DLL can be written which to responds to new documents being placed in the <strong>dbo.DocumentsForPosting</strong> database table.</p>
<p>The format of the document xml which is stored in this table is defined by the various document export application hooks.  (These are detailed separately.)</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Although titled <em>Invoice Export</em> this process also applied to other document types such as Credit Notes and Expense Claims</p>
</div>
<h2 id="implementation">Implementation</h2>
<ul>
<li>
<p>Create a new C# Class Library project called xyzExportProcessor. ( <em>xyz</em> can be anything)</p>
</li>
<li>
<p>Add a reference to <strong>Purchasing Server\bin\PROACTIS.P2P.grsCustInterfaces.dll</strong></p>
</li>
<li>
<p>Add a class called <strong>Services</strong> which implements the <strong>grsCustInterfaces.IExportProcessor</strong> interface.</p>
</li>
<li>
<p>Write implementations of the following methods:</p>
<ul>
<li><strong>grsCustInterfaces.IExportProcessor.Initialise</strong>.</li>
<li><strong>grsCustInterfaces.IExportProcessor.ProcessDocument</strong>.</li>
<li><strong>grsCustInterfaces.IExportProcessor.PostingComplete</strong>.</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The methods are called in the order listed above.</p>
<ol>
<li>The documents are retrieved from the database</li>
<li>Initialise is called just once</li>
<li>ProcessDocument is then called one for each document</li>
<li>PostingComplete is called just once after all calls to ProcessDocument.</li>
</ol>
</div>
<hr />
<h2 id="initialise-method">Initialise Method</h2>
<p>This method is called first after the pending documents have been retrieved from the database.  This method is typically used to make connections to external systems (databases) and to specify the transaction handling model to be used.</p>
<h3 id="signature">Signature</h3>
<pre><code>ExportProcessorInitialiseResult Initialise(int numberOfDocuments, string databaseTitle, string databaseName, string databaseServer)
</code></pre>

<h3 id="arguments">Arguments</h3>
<table>
<thead>
<tr>
<th>Argument</th>
<th>Direction</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>numberOfDocuments</td>
<td>In</td>
<td>The number of pending documents in the <strong>dbo.DocumentsForPosting</strong> table. Will always be &gt; 0</td>
</tr>
<tr>
<td>databaseTitle</td>
<td>In</td>
<td>Title of the p2p database</td>
</tr>
<tr>
<td>databaseName</td>
<td>In</td>
<td>Name of the p2p database</td>
</tr>
<tr>
<td>databaseServer</td>
<td>In</td>
<td>Name of the p2p database server</td>
</tr>
</tbody>
</table>
<h3 id="returns">Returns</h3>
<p>Returns a value from the <strong>ExportProcessorInitialiseResult</strong> enumeration</p>
<ol>
<li>OneTransactionPerDocument - used for posting documents individually</li>
<li>SingleTransactionForAllDocuments - used for posting all the documents in bulk</li>
</ol>
<hr />
<h2 id="processdocument-method">ProcessDocument Method</h2>
<p>This method is called once for each document to be processed.</p>
<h3 id="signature_1">Signature</h3>
<pre><code class="csharp">ExportProcessorExportResult ProcessDocument(Guid guid, string documentNumber, string documentXml, Guid documentGuid, string documentType, string description);
</code></pre>

<h3 id="arguments_1">Arguments</h3>
<table>
<thead>
<tr>
<th>Argument</th>
<th>Direction</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Guid</td>
<td>In</td>
<td>GUID which identifies the unique entry in <strong>dbo.DocumentsForPosting</strong></td>
</tr>
<tr>
<td>documentNumber</td>
<td>In</td>
<td>The Document Number,  for example PINV1234</td>
</tr>
<tr>
<td>documentXml</td>
<td>In</td>
<td>The XML as generated by the application hook</td>
</tr>
<tr>
<td>documentGuid</td>
<td>In</td>
<td>The GUID of the document which is being exported. (For example GUID from <strong>dsdba.Invoices</strong>)</td>
</tr>
<tr>
<td>documentType</td>
<td>In</td>
<td>The type of the document which is being exported. (For example INVOICE)</td>
</tr>
<tr>
<td>description</td>
<td>In</td>
<td>Name of the target system.  Always EXTERNAL in practice.</td>
</tr>
</tbody>
</table>
<h3 id="returns_1">Returns</h3>
<p>Returns a value from the <strong>ExportProcessorExportResult</strong> enumeration</p>
<ol>
<li>Success - The document was successfully posted and it's status should be updated to Posted and it's commitments released.</li>
<li>Skipped - This interface doesn't wish to post this document.</li>
<li>SuccessButDoNotMarkAsPosted - The document was successfully posted but it's status should NOT be updated to Posted and it's commitments should NOT be released. </li>
<li>SecondarySuccess - This is not the primary document generated by an application hook.</li>
</ol>
<hr />
<h2 id="postingcomplete-method">PostingComplete Method</h2>
<p>This method is called last,  after <strong>ProcessDocument</strong> has been called for each pending document.</p>
<h3 id="signature_2">Signature</h3>
<pre><code class="csharp">void PostingComplete();
</code></pre>

<h3 id="arguments_2">Arguments</h3>
<p>None</p>
<h3 id="returns_2">Returns</h3>
<p>Void</p>
<hr />
<h2 id="transaction-handling">Transaction Handling</h2>
<p>There are two transaction handling modes available depending on the type of system you are interfacing with.</p>
<h3 id="onetransactionperdocument">OneTransactionPerDocument</h3>
<p>This is the more traditional model where each document is process in it's own transaction.</p>
<ol>
<li>The documents are retrieved from the database</li>
<li>Initialise is called and returns a value of <strong>OneTransactionPerDocument</strong></li>
<li>Each call to ProcessDocument is in it's own transaction</li>
<li>The final call to PostingComplete is not in a transaction.</li>
</ol>
<p>If an exception is thrown by <strong>ProcessDocument</strong> then the error message is record in the <strong>dbo.DocumentsForPosting</strong> table and process continues with the next document.</p>
<h3 id="singletransactionforalldocuments">SingleTransactionForAllDocuments</h3>
<p>This means that either all documents will be exported or none of them.  This is typically used when writing to flat files.</p>
<ol>
<li>The documents are retrieved from the database</li>
<li>Initialise is called and returns a value of <strong>SingleTransactionForAllDocuments</strong></li>
<li>A transaction scope is then created<ul>
<li>Each call to ProcessDocument is then within this transaction</li>
<li>The final call to PostingComplete is also within this transaction.</li>
</ul>
</li>
</ol>
<p>If an exception is thrown by either <strong>ProcessDocument</strong> or <strong>PostingComplete</strong> then entire process is rolled back and the error is recorded in the windows event log.</p>
<h3 id="no-transactions">No Transactions</h3>
<p>By default your code will run in the transaction provided by the calling service.  If you wish your database code to run outside of this transaction scope,  then the following code maybe used</p>
<pre><code class="csharp">using (var tx = new TransactionScope(TransactionScopeOption.Suppress))
{
    // ... your database code here...
}
</code></pre>

<hr />
<h2 id="example">Example</h2>
<p>See the <a href="https://github.com/proactis-documentation/ExampleApplications/tree/master/P2P/Exports">example applications</a> for complete implementations.</p>
<hr />
<h2 id="deployment">Deployment</h2>
<p>Edit the file <strong>"ConfigurationFolder\PROACTIS.P2P.AccountingExportService.exe.config"</strong> and ensure that the value for <strong>VBProgID</strong> is set to blank.</p>
<pre><code class="xml">&lt;add key=&quot;VBProgID&quot; value=&quot;&quot;/&gt;
</code></pre>

<p>Your dll should be complied (and named xyzExportProcessor.dll) and then copied into your <strong>PROACTIS P2P/Plugins</strong>  (or <strong>Plugins/[database-title]</strong>) folder.</p>
<p>As the <strong>PROACTIS P2P Accounting Export Service</strong> starts it will write a message to Windows Event Log listing the databases/plugins which will be used.</p>
<p><img alt="alt text" src="../../img/p2p/exports/servicestartup.JPG" title="Upload" /></p>
<h2 id="database">Database</h2>
<p>The pending documents are held in the database table <strong>dbo.DocumentsForPosting</strong>.  In order to maintain compatibility with legacy code there is a view of this table called <strong>dbo.InvoicesForPosting</strong>.  For all new development the use of the base table is preferred. </p></div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>(C) PROACTIS Group Ltd - All Rights Reserved</p>
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script><div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
